<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer and Goal Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .chart-container {
            width: 300px;
            height: 300px;
            margin: 20px;
        }
        .stats {
            text-align: center;
            margin-top: 10px;
        }
        #countdownTimer {
            font-size: 1.5em;
            font-weight: bold;
        }
        #timerStats {
            font-size: 1.2em;
            margin-top: 10px;
        }
        #targetDateDisplay {
            font-size: 1.2em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<canvas id="myCanvas"></canvas>
    <h1>Timer and Goal Tracker</h1>
    <div id="errorMessage" style="color: red;"></div>

    <!-- Timer Section -->
    <div id="countdownTimer"></div>
    <div id="timerStats"></div>
    <div id="targetDateDisplay"></div>

    <div class="container">
        <!-- Timer Chart -->
        <div class="chart-container">
            <canvas id="timerChart"></canvas>
        </div>

        <!-- Goal Charts -->
        <div class="chart-container">
            <canvas id="followerChart"></canvas>
            <div id="followerStats" class="stats"></div>
        </div>

        <div class="chart-container">
            <canvas id="subscriptionChart"></canvas>
            <div id="subscriptionStats" class="stats"></div>
        </div>

        <div class="chart-container">
            <canvas id="bitsChart"></canvas>
            <div id="bitsStats" class="stats"></div>
        </div>

        <div class="chart-container">
            <canvas id="donationChart"></canvas>
            <div id="donationStats" class="stats"></div>
        </div>
		<div id="refreshTracker" style="text-align:center; margin-top:20px; font-size:1.2em; color:blue;">
			Last refresh: N/A
		</div>

    </div>
	
<script>
/* ======================================================
   CONFIG
====================================================== */
const API_BASE =
  "https://script.google.com/macros/s/AKfycby4UKXfW68KHrWyGoRUpuPnUcTk2Eu2SyLxm3XrcYPX7qwtlWG6I02WWrckkbAgI3Af/exec";

const REFRESH_INTERVAL = 5000;

/* ======================================================
   STATE
====================================================== */
let timers = [];
let goals = {
  followers: { current: 0, goal: 0 },
  subs: { current: 0, goal: 0 },
  bits: { current: 0, goal: 0 },
  donations: { current: 0, goal: 0 }
};

/* ======================================================
   CANVAS SETUP
====================================================== */
const canvas = document.getElementById("myCanvas");
const ctx = canvas.getContext("2d");

canvas.width = 2200;
canvas.height = 2200;

const centerX = canvas.width / 2;
const centerY = canvas.height / 2;

const cameraRadius = 670;
const donutWidth = 40;
const donutSpacing = 15;
const baseRadius = cameraRadius + donutSpacing + donutWidth;

const cameraImage = new Image();
cameraImage.src =
  "https://static-cdn.jtvnw.net/jtv_user_pictures/4ae8547d-3e84-47bd-a024-ba09885f1bbe-profile_image-300x300.png";

/* ======================================================
   UTILITIES
====================================================== */
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("Fetch failed");
  return res.json();
}

function clamp01(v) {
  return Math.max(0, Math.min(1, v));
}

function getTimerProgress(timer) {
  const now = Date.now();
  const start = timer.startTime.getTime();
  const end = timer.endTime.getTime();

  if (now < start) return 0;
  if (now > end) return 1;

  return clamp01((now - start) / (end - start));
}

function formatRemaining(ms) {
  if (ms <= 0) return "Time's up!";

  const d = Math.floor(ms / 86400000);
  const h = Math.floor((ms % 86400000) / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);

  return `${d}d ${h}h ${m}m ${s}s`;
}

/* ======================================================
   DATA LOADERS
====================================================== */
async function loadTimers() {
  const data = await fetchJSON(`${API_BASE}?action=getTimers`);
  timers = data.map(t => ({
    timerName: t.timerName,
    startTime: new Date(t.startTime),
    endTime: new Date(t.endTime)
  }));
}

async function loadGoals() {
  const map = {
    "Follower Goal": "followers",
    "Subscription Goal": "subs",
    "Bits Goal": "bits",
    "Donation Goal": "donations"
  };

  for (const [sheetName, key] of Object.entries(map)) {
    const g = await fetchJSON(
      `${API_BASE}?action=getGoal&goalType=${encodeURIComponent(sheetName)}`
    );
    goals[key].current = g.CurrentCount;
    goals[key].goal = g.goalValue;
  }
}

/* ======================================================
   COUNTDOWN DISPLAY
====================================================== */
function updateCountdownDisplay() {
  const el = document.getElementById("countdownTimer");
  if (!el) return;

  if (!timers.length) {
    el.textContent = "No active timers";
    return;
  }

  // Show soonest-ending timer
  const next = timers.reduce((a, b) =>
    a.endTime < b.endTime ? a : b
  );

  const remaining = next.endTime - Date.now();
  el.textContent = `${next.timerName}: ${formatRemaining(remaining)}`;
}

/* ======================================================
   DRAWING
====================================================== */
function drawCamera() {
  ctx.save();
  ctx.beginPath();
  ctx.arc(centerX, centerY, cameraRadius, 0, Math.PI * 2);
  ctx.clip();
  ctx.drawImage(
    cameraImage,
    centerX - cameraRadius,
    centerY - cameraRadius,
    cameraRadius * 2,
    cameraRadius * 2
  );
  ctx.restore();

  ctx.lineWidth = 8;
  ctx.strokeStyle = "#FF0000CC";
  ctx.beginPath();
  ctx.arc(centerX, centerY, cameraRadius, 0, Math.PI * 2);
  ctx.stroke();
}

function drawDonut(radius, pct, color) {
  if (pct <= 0) return;

  const start = -Math.PI / 2;
  const end = start + Math.PI * 2 * pct;

  ctx.lineWidth = donutWidth;
  ctx.strokeStyle = color;
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, start, end);
  ctx.stroke();
}

function drawAll() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawCamera();

  updateCountdownDisplay();

  const items = [];

  // Goals
  items.push(
    { label: "Followers", pct: goals.followers.current / goals.followers.goal },
    { label: "Subs", pct: goals.subs.current / goals.subs.goal },
    { label: "Bits", pct: goals.bits.current / goals.bits.goal },
    { label: "Donations", pct: goals.donations.current / goals.donations.goal }
  );

  // Timers
  timers.forEach(t => {
    items.push({
      label: t.timerName,
      pct: getTimerProgress(t)
    });
  });

  items.sort((a, b) => b.pct - a.pct);

  items.forEach((item, i) => {
    drawDonut(
      baseRadius + i * (donutWidth + donutSpacing),
      clamp01(item.pct),
      "#4CAF50"
    );
  });

  requestAnimationFrame(drawAll);
}

/* ======================================================
   REFRESH LOOP
====================================================== */
setInterval(async () => {
  await loadTimers();
  await loadGoals();
  document.getElementById("refreshTracker").textContent =
    "Last refresh: " + new Date().toLocaleTimeString();
}, REFRESH_INTERVAL);

/* ======================================================
   INIT
====================================================== */
async function init() {
  await Promise.all([loadTimers(), loadGoals()]);
  cameraImage.onload = drawAll;
}

init();
</script>


</body>
</html>
